var canvas=document.getElementById("backdrop"),ctx=canvas.getContext("2d"),mCanvas=document.getElementById("mii"),mCtx=mCanvas.getContext("2d"),oCanvas=document.getElementById("output"),oCtx=oCanvas.getContext("2d"),settings=[],paddingTop=164,paddingBottom=244;function updateSettings(){settings.id=document.getElementsByName("id")[0].value,settings.version=document.getElementsByName("version")[0].value,settings.expression=document.getElementsByName("expression")[0].value,settings.color=document.getElementsByName("color")[0].value,document.getElementsByName("shirts")[0].checked?settings.clothesColor=settings.color:settings.clothesColor="default",document.getElementById("font").textContent="#valentine, #message { font-family: '"+document.getElementsByName("font")[0].value+"', sans-serif; }",ctx.font="40px "+document.getElementsByName("font")[0].value,document.getElementById("to").textContent="To: "+document.getElementById("to-input").value,document.getElementById("from").textContent="From: "+document.getElementById("from-input").value}function getColors(){switch(settings.color){case"red":colors=["#ff0000","#ffa000","#ff0000"];break;case"orange":colors=["#ff8000","#806000","#ff8000"];break;case"yellow":colors=["#ffff40","#d8b000","#ffff40"];break;case"yellowgreen":colors=["#00ff00","#00c000","#00ff00"];break;case"skyblue":colors=["#00ffff","#0000ff","#0080ff"];break;case"purple":colors=["#8000ff","#600060","#a000a0"];break;case"white":colors=["#ffffff","#808080","#ffffff"];break;case"black":colors=["#606060","#000000","#000000"];break;default:colors=["#ff00ff","#8000ff","#ff00ff"]}return colors}function drawCanvas(e){var t=new Image;t.src="background.png",t.onload=function(){var n=e.createLinearGradient(0,0,0,512),o=getColors();n.addColorStop(0,o[0]),n.addColorStop(1,o[1]),e.fillStyle=n,e.fillRect(0,0,canvas.width,canvas.height),e.drawImage(t,0,0),drawMii()}}function drawMii(){mCtx.clearRect(0,0,mCanvas.width,mCanvas.height);var e=new Image;e.crossOrigin="anonymous",e.src="https://cdn-mii.accounts.nintendo.com/"+encodeURIComponent(settings.version)+".0.0/miis/"+encodeURIComponent(settings.id)+"/image/aaaaaaaaaaaaaaaa-aaaaaaaaaaaaaaaa.png?type=face&width=512&expression="+encodeURIComponent(settings.expression)+"&characterYRotate=345&clothesColor="+encodeURIComponent(settings.clothesColor),e.onload=function(){for(var t=[-1,-1,0,-1,1,-1,-1,0,1,0,-1,1,0,1,1,1],n=0;n<t.length;n+=2)mCtx.drawImage(e,4*t[n],4*t[n+1]);mCtx.globalCompositeOperation="source-in",mCtx.fillStyle="#fff",mCtx.fillRect(0,0,mCanvas.width,mCanvas.height),mCtx.globalCompositeOperation="source-over",mCtx.drawImage(e,0,0),ctx.drawImage(mCanvas,512,0)}}function updateImage(){updateSettings(),drawCanvas(ctx),document.getElementById("to").style.cssText="color: "+getColors()[2],document.getElementById("from").style.cssText="color: "+getColors()[2],document.getElementById("message").style.cssText="color: "+getColors()[2],document.getElementById("message").style.paddingTop=paddingTop+"px",document.getElementById("message").style.paddingBottom=paddingBottom+"px"}document.getElementById("download").onclick=function(){window.scrollTo(0,0),document.getElementById("valentine").style.csstext="background-image: "+canvas.toDataURL();var e=-.5*(512-document.documentElement.clientWidth);e<0&&(e=0),html2canvas(document.getElementById("valentine"),{canvas:document.getElementById("output"),width:1024,height:512,x:document.getElementById("valentine").scrollWidth/2-512}).then(function(){var e=document.createElement("a");e.download="valentine.png",e.href=oCanvas.toDataURL(),document.body.appendChild(e),e.click(),document.body.removeChild(e),delete e})};for(var es=0;es<document.getElementsByTagName("select").length;es++)document.getElementsByTagName("select")[es].onchange=updateImage;for(es=0;es<document.querySelectorAll("input[type=checkbox]").length;es++)document.querySelectorAll("input[type=checkbox]")[es].onchange=updateImage;document.getElementById("message").onscroll=function(){this.scrollLeft=0},document.getElementById("message").onscroll=function(){this.scrollTop=0,this.scrollLeft=0},document.getElementById("message").oninput=function(){for(var e=this.value.split(/\r*\n/),t=0;t<e.length;t++)if(ctx.measureText(e[t]).width>496)for(var n="",o=-1,a=0;a<e[t].length-1;a++)n+=e[t].charAt(a)," "==e[t].charAt(a)&&(o=a),ctx.measureText(n).width>496&&(-1===o?(void 0===e[t+1]?e[t+1]=e[t].substr(a+1):e[t+1]=e[t].substr(a+1)+e[t+1],e[t]=n.substr(0,a+1)):(void 0===e[t+1]?e[t+1]=e[t].substr(o+1):e[t+1]=e[t].substr(o+1)+e[t+1],e[t]=e[t].substr(0,o+1)));e.length>8&&(e=e.slice(0,8)),this.value=e.join("\n"),paddingTop=184-20*e.length,paddingBottom=420-paddingTop,this.style.paddingTop=paddingTop+"px",this.style.paddingBottom=paddingBottom+"px"},document.getElementsByName("id")[0].oninput=updateImage,document.getElementById("to-input").oninput=updateSettings,document.getElementById("from-input").oninput=updateSettings,window.onload=updateImage;